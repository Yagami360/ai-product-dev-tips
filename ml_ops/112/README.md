# Slurm をインストールする

## 方法（Ubuntu や Debian の場合）

1. パッケージをアップデートする
    ```bash
    sudo apt update
    ```

1. MUNGE をインストールする
    ```bash
    sudo apt update
    sudo apt install -y libmunge-dev
    ```

    > MUNGE: HPC [High Performance Computing] 環境でよく使用されるライブラリで、Slurm などでのノード間通信を安全に行うための認証を提供する

1. MUNGE を起動する
    ```bash
    sudo systemctl enable munge
    sudo systemctl start munge
    ```

    MUNGE の起動状態を確認する場合は、以下のコマンドを実行する
    ```bash
    sudo systemctl status munge
    ```
    ```bash
    ● munge.service - MUNGE authentication service
        Loaded: loaded (/lib/systemd/system/munge.service; enabled; vendor preset: enabled)
        Active: active (running) since Thu 2024-11-28 01:36:31 UTC; 1 months 1 days ago
        Docs: man:munged(8)
    Main PID: 529 (munged)
        Tasks: 4 (limit: 17974)
        Memory: 1.9M
            CPU: 24.183s
        CGroup: /system.slice/munge.service
                └─529 /usr/sbin/munged

    Nov 28 01:36:30 sakai-dev systemd[1]: Starting MUNGE authentication service...
    Nov 28 01:36:31 sakai-dev systemd[1]: Started MUNGE authentication service.
    ```

1. libdbus-1-dev をインストールする<br>
    後述の slurmd 起動時に、`slurmd: error: cannot create cgroup context for cgroup/v2` エラーが出る場合は、libdbus-1-dev をインストールする
    ```bash
    sudo apt install -y libdbus-1-dev
    ```

1. gcc をインストールする
    ```bash
    sudo apt install -y build-essential
    ```
    ```bash
    # gcc のバージョンを確認する
    gcc --version
    ```
    SLURM をビルドする際に必要になるため、gcc をインストールする

1. SLURM をインストールする
    1. SLURM のダウンロード
        ```bash
        cd ${HOME}
        wget https://download.schedmd.com/slurm/slurm-22.05.8.tar.bz2
        tar xvjf slurm-22.05.8.tar.bz2
        cd ${HOME}/slurm-22.05.8
        ```

    1. SLURM のビルド
        ```bash
        # インストール可能な環境か確認し、Makefile を作成する
        ./configure --with-munge

        # Makefile からビルドしてインストール
        make
        sudo make install
        ```

1. SLURM の設定ファイルを作成する<br>
    SLURM の各種設定は、`slurm.conf` で行う。
    SLURM のインストール後に、`slurm-${SLURM_VERSION}/etc` ディレクトリ以下に `slurm.conf.example` が作成されるので、このファイルを `/usr/local/etc/slurm.conf` にコピーして設定を行う。

    ```bash
    sudo cp etc/slurm.conf.example /usr/local/etc/slurm.conf
    sudo vi /usr/local/etc/slurm.conf
    ```

    - `slurm.conf` の設定例
        ```conf
        # slurm.conf file generated by configurator easy.html.
        # Put this file on all nodes of your cluster.
        # See the slurm.conf man page for more information.
        #
        ClusterName=sakai-dev-cluster
        SlurmctldHost=sakai-dev      # hostname -s で確認可能
        #
        #MailProg=/bin/mail
        MpiDefault=none
        #MpiParams=ports=#-#
        ProctrackType=proctrack/cgroup
        # ProctrackType=proctrack/linuxproc
        ReturnToService=1
        SlurmctldPidFile=/var/run/slurmctld.pid
        #SlurmctldPort=6817
        SlurmdPidFile=/var/run/slurmd.pid
        #SlurmdPort=6818
        SlurmdSpoolDir=/var/spool/slurmd
        SlurmUser=slurm
        #SlurmdUser=root
        StateSaveLocation=/var/spool/slurmctld
        SwitchType=switch/none
        TaskPlugin=task/affinity,task/cgroup
        #
        #
        # TIMERS
        #KillWait=30
        #MinJobAge=300
        #SlurmctldTimeout=120
        #SlurmdTimeout=300
        #
        #
        # SCHEDULING
        SchedulerType=sched/backfill
        SelectType=select/cons_tres
        #
        #
        # LOGGING AND ACCOUNTING
        AccountingStorageType=accounting_storage/none
        #JobAcctGatherFrequency=30
        JobAcctGatherType=jobacct_gather/none
        #SlurmctldDebug=info
        SlurmctldLogFile=/var/log/slurmctld.log
        #SlurmdDebug=info
        SlurmdLogFile=/var/log/slurmd.log
        #
        #
        # COMPUTE NODES（'/usr/local/sbin/slurmd -C' で確認可能）
        NodeName=sakai-dev CPUs=4 State=UNKNOWN
        PartitionName=debug Nodes=ALL Default=YES MaxTime=INFINITE State=UP
        ```

    各設定項目の意味は、https://slurm.schedmd.com/configurator.easy.html で確認できる

1. （オプション）SLURM 実行用のユーザーを作成する<br>
    `slurm.conf` で `SlurmUser=slurm` とした場合は、SLURM 実行用のユーザー `slurm` を作成する
    ```bash
    # ユーザーを作成する（例：USER ID を 5000 とする場合）
    sudo groupadd -g 5000 slurm
    sudo useradd -M -d /var/lib/slurm -s /sbin/nologin -u 5000 -g slurm slurm
    ```
    ```bash
    # 各種パーミッションを設定する
    sudo mkdir -p /var/lib/slurm/spool
    sudo mkdir -p /var/log/slurm

    sudo chown -R slurm:slurm /var/log/slurm
    sudo chown -R slurm:slurm /var/lib/slurm
    ```

1. `slurmctld` と `slurmd` を起動する<br>
    各サーバーのリソース監視を行う Slurm の管理用デーモンである `slurmctld` と、各計算ノードにおけるジョブの実行管理や監視を行う `slurmd` を起動する。

    SLURM のインストール後に、`slurm-${SLURM_VERSION}/etc` ディレクトリ以下に `slurmctld` と `slurmd` を起動するためのファイルが作成されているので、これらのファイルをコピーして、`slurmctld` と `slurmd` を起動する
    ```bash
    sudo cp etc/slurmctld.service /etc/systemd/system
    sudo cp etc/slurmd.service /etc/systemd/system
    ```
    ```bash
    sudo systemctl start slurmctld slurmd
    ```

    `slurmctld` と `slurmd` の起動状態を確認する場合は、以下のコマンドを実行する
    ```bash
    sudo systemctl status slurmctld slurmd
    ```
    ```bash
    ● slurmctld.service - Slurm controller daemon
     Loaded: loaded (/etc/systemd/system/slurmctld.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2024-11-28 01:36:31 UTC; 1 months 1 days ago
   Main PID: 598 (slurmctld)
      Tasks: 11
     Memory: 8.0M
        CPU: 23min 1.605s
     CGroup: /system.slice/slurmctld.service
             ├─598 /usr/local/sbin/slurmctld -D -s
             └─613 slurmctld: slurmscriptd

    ● slurmd.service - Slurm node daemon
        Loaded: loaded (/etc/systemd/system/slurmd.service; enabled; vendor preset: enabled)
        Active: active (running) since Thu 2024-11-28 01:36:31 UTC; 1 months 1 days ago
    Main PID: 599 (slurmd)
        Tasks: 1
        Memory: 2.8M
            CPU: 10.854s
        CGroup: /system.slice/slurmd.service
                └─599 /usr/local/sbin/slurmd -D -s
    ```

1. （オプション）`slurmctld` と `slurmd` を自動起動するように設定する<br>
    ```bash
    sudo systemctl enable slurmctld slurmd
    ```
