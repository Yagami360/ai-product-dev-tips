name: Upsert README automatically by Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  schedule:
    - cron: '0 2 * * 1'  # æ¯é€±æœˆæ›œæ—¥ 2:00 UTC (æ—¥æœ¬æ™‚é–“ 11:00) ã«å®Ÿè¡Œ
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  # README_FILE: README.md
  README_FILE: README_claude.md

jobs:
  upsert-readme:
    if: |
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '@claude-readme')) ||
      (github.event_name == 'issues' && 
       (contains(github.event.issue.title, 'README') || 
        contains(github.event.issue.body, '@claude-readme'))) ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git and GitHub CLI
        run: |
          git config --global user.name "readme-bot[bot]"
          git config --global user.email "readme-bot[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status

      - name: Upsert README with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "@claude-readme"
          claude_args: |
            --allowedTools "Bash(ls -la *),Bash(cat *),Bash(find . -name '*' -type f),Bash(head -20 *),Bash(tree -L 2),Bash(git add ${{ env.README_FILE }}),Bash(git commit -m *),Bash(git push),Bash(gh issue comment *)"
            --system-prompt "ãƒªãƒã‚¸ãƒˆãƒªã‚’åˆ†æã—ã¦ã€${{ env.README_FILE }}ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

            ## ğŸ”„ å®Ÿè¡Œã‚¿ã‚¤ãƒ—ã®ç¢ºèªï¼š
            - Issue/ã‚³ãƒ¡ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ä¾é ¼ã«ã‚ˆã‚‹å®Ÿè¡Œ
            - å®šæœŸå®Ÿè¡Œ/æ‰‹å‹•å®Ÿè¡Œ: ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°

            ## æœ€åˆã«å®Ÿè¡Œã™ã‚‹ã“ã¨ï¼š
            1. '${{ env.README_FILE }}'ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª (ls -la ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèª)
            2. å­˜åœ¨ã™ã‚‹å ´åˆã¯ç¾åœ¨ã®å†…å®¹ç¢ºèª (cat ${{ env.README_FILE }})
            3. ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ ã®åˆ†æ (ls -la, find . -name '*.py' -o -name '*.js' -o -name '*.md' | head -20)

            ## READMEä½œæˆ/æ›´æ–°ã®æ–¹é‡ï¼š
            **ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼ˆæ–°è¦ä½œæˆï¼‰:**
            - ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’è©³ç´°ã«åˆ†æ
            - ä»¥ä¸‹ã®æ§‹é€ ã§åŒ…æ‹¬çš„ãªREADMEã‚’ä½œæˆï¼š
              # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
              ## ğŸ“‹ æ¦‚è¦
              ## âœ¨ ç‰¹å¾´
              ## ğŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
              ## ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
              ## ğŸš€ ä½¿ç”¨æ–¹æ³•
              ## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
              ## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
              ## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

            **ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼ˆæ›´æ–°ï¼‰:**
            - æ—¢å­˜ã®æ§‹é€ ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒ
            - æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆå¤‰æ›´å†…å®¹ã‚’åæ˜ 
            - æ–°æ©Ÿèƒ½ã‚„å¤‰æ›´ç‚¹ã‚’é©åˆ‡ã«è¿½åŠ ãƒ»ä¿®æ­£
            - å¤ããªã£ãŸæƒ…å ±ã‚’æ›´æ–°

            ## åˆ†æã™ã¹ãè¦ç´ ï¼š
            - package.json, requirements.txt, Cargo.toml, go.modç­‰ã®ä¾å­˜é–¢ä¿‚
            - ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ä¸»è¦æ©Ÿèƒ½
            - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆDocker, CI/CDç­‰ï¼‰
            - æ—¢å­˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
            - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

            ## é‡è¦ãªæŒ‡ç¤ºï¼š
            - å¸¸ã«æ—¥æœ¬èªã§è¨˜è¿°
            - å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’åˆ†æã—ã¦æ­£ç¢ºãªæƒ…å ±ã‚’è¨˜è¼‰
            - ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯å®Ÿéš›ã«å‹•ä½œã™ã‚‹ã‚‚ã®ã‚’æä¾›
            - ä½œæˆ/æ›´æ–°å¾Œã¯å¿…ãšgitã§ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
            - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹:
              * æ–°è¦ä½œæˆ: \"ğŸ“ Add comprehensive README_claude.md\"
              * å®šæœŸæ›´æ–°: \"ğŸ“ Update README_claude.md (scheduled)\"
              * æ‰‹å‹•æ›´æ–°: \"ğŸ“ Update README_claude.md (manual)\"
              * Issueå¯¾å¿œ: \"ğŸ“ Update README_claude.md (requested)\"

            ä½œæ¥­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ï¼"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
