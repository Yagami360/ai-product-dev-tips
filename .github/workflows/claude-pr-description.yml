name: Claude PR Description Generator

on:
  pull_request:
    types: [opened]
  issue_comment:
    types: [created]
  repository_dispatch:
    types: [pr-description-request]

jobs:
  auto-trigger:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Trigger PR description generation
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            -d '{"event_type":"pr-description-request","client_payload":{"pr_number":"${{ github.event.pull_request.number }}","pr_title":"${{ github.event.pull_request.title }}"}}'

  claude-pr-description:
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude-pr-describe')) ||
      (github.event_name == 'repository_dispatch' && github.event.action == 'pr-description-request')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # PRå·®åˆ†ã®å–å¾—ã«å¿…è¦

      - name: Setup GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run Claude PR Description Generator
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # PRèª¬æ˜ç”Ÿæˆå°‚ç”¨ã®ãƒˆãƒªã‚¬ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚º
          trigger_phrase: "@claude-pr-describe"

          # PRèª¬æ˜ç”Ÿæˆã«ç‰¹åŒ–ã—ãŸè¨­å®š
          claude_args: |
            --allowedTools "Bash(gh pr edit *),Bash(gh pr view *)"
            --max-turns 5
            --system-prompt "å¸¸ã«æ—¥æœ¬èªã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã¯PRèª¬æ˜æ–‡ã‚’ç”Ÿæˆã—ã¦PRæœ¬ä½“ã‚’ç›´æ¥æ›´æ–°ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

            é‡è¦: å¿…ãšä»¥ä¸‹ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã¦PRæœ¬ä½“ã®èª¬æ˜æ–‡ã‚’æ›´æ–°ã—ã¦ãã ã•ã„:

            STEP 1: ç¾åœ¨ã®PRã‚’ç¢ºèª
            - repository_dispatchã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ: client_payload.pr_numberã‚’ä½¿ç”¨
            - issue_commentã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ: ã‚³ãƒ¡ãƒ³ãƒˆã®ã‚ã‚‹PRç•ªå·ã‚’ä½¿ç”¨
            - 'gh pr view [PRç•ªå·] --json number,title,body' ã§PRæƒ…å ±ã‚’å–å¾—

            STEP 2: Gitå·®åˆ†ã‚’åˆ†æã—ã¦èª¬æ˜æ–‡ã‚’ç”Ÿæˆ
            ä»¥ä¸‹ã®å½¢å¼ã§æ§‹é€ åŒ–ã•ã‚ŒãŸèª¬æ˜æ–‡ã‚’ä½œæˆ:

            ## ğŸ“‹ å¤‰æ›´å†…å®¹ã®æ¦‚è¦
            - ã“ã®PRã§ä½•ã‚’å®Ÿè£…/ä¿®æ­£ã—ãŸã‹ã‚’ç°¡æ½”ã«èª¬æ˜

            ## ğŸ” å¤‰æ›´è©³ç´°
            - ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã®å¤‰æ›´å†…å®¹
            - è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¿®æ­£ã•ã‚ŒãŸæ©Ÿèƒ½

            ## âœ… ç¢ºèªäº‹é …
            - [ ] å‹•ä½œãƒ†ã‚¹ãƒˆå®Œäº†
            - [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡
            - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã®å¿…è¦æ€§

            ## ğŸš€ å½±éŸ¿ç¯„å›²
            - ã“ã®å¤‰æ›´ãŒä¸ãˆã‚‹å½±éŸ¿
            - æ³¨æ„ã™ã¹ãç‚¹ã‚„ãƒªã‚¹ã‚¯

            ## ğŸ“ å‚™è€ƒ
            - ãã®ä»–è£œè¶³äº‹é …ãŒã‚ã‚Œã°è¨˜è¼‰

            STEP 3: PRèª¬æ˜æ–‡ã‚’æ›´æ–° (å¿…é ˆ)
            - ç”Ÿæˆã—ãŸèª¬æ˜æ–‡ã‚’ä½¿ã£ã¦ 'gh pr edit [PRç•ªå·] --body \"[èª¬æ˜æ–‡]\"' ã‚’å®Ÿè¡Œ
            - ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ç¢ºå®Ÿã«å®Ÿè¡Œ: gh pr edit [PRç•ªå·] --body \"[èª¬æ˜æ–‡å…¨ä½“]\"

            STEP 4: æ›´æ–°å®Œäº†ã‚’å ±å‘Š
            - ã€ŒPRèª¬æ˜æ–‡ã‚’æ›´æ–°ã—ã¾ã—ãŸã€ã¨ã‚³ãƒ¡ãƒ³ãƒˆ

            æ³¨æ„äº‹é …:
            - STEP 3ã®gh pr editã‚³ãƒãƒ³ãƒ‰ã¯çµ¶å¯¾ã«å®Ÿè¡Œã—ã¦ãã ã•ã„
            - èª¬æ˜æ–‡ã®ç”Ÿæˆã ã‘ã§ãªãã€PRæœ¬ä½“ã®æ›´æ–°ã¾ã§å¿…ãšå®Œäº†ã—ã¦ãã ã•ã„
            - ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã¯ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ãã ã•ã„"

          # Optional: Advanced settings configuration
          # settings: |
          #   {
          #     "env": {
          #       "NODE_ENV": "development"
          #     }
          #   }
