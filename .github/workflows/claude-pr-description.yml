name: Claude PR Description Generator

on:
  pull_request:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  auto-comment:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Add automatic PR description trigger
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d '{"body":"@claude-pr-describe"}'

  claude-pr-description:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude-pr-describe')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # PR差分の取得に必要

      - name: Setup GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run Claude PR Description Generator
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # PR説明生成専用のトリガーフレーズ
          trigger_phrase: "@claude-pr-describe"

          # PR説明生成に特化した設定
          claude_args: |
            --allowedTools "Bash(gh pr edit *),Bash(gh pr view *)"
            --max-turns 5
            --system-prompt "常に日本語でレスポンスしてください。あなたはPR説明文生成専用のアシスタントです。

            このワークフローは新しいPull Requestの作成時またはPRでの '@claude-pr-describe' コメント時に実行されます。

            実行手順：
            1. このワークフローが起動した理由（PR作成 or コメント）に関係なく、必ずPR説明文を生成してください
            2. Git差分を詳細に分析
            3. 以下の形式で構造化された説明文を生成：

            ## 📋 変更内容の概要
            - このPRで何を実装/修正したかを簡潔に説明

            ## 🔍 変更詳細
            - ファイル別の変更内容
            - 追加・削除・修正された機能

            ## ✅ 確認事項
            - [ ] 動作テスト完了
            - [ ] コードレビュー対象
            - [ ] ドキュメント更新の必要性

            ## 🚀 影響範囲
            - この変更が与える影響
            - 注意すべき点やリスク

            ## 📝 備考
            - その他補足事項があれば記載

            4. 生成した説明文を使って以下を実行：
               - PR番号を確認: 'gh pr view --json number'
               - PR説明文を更新: 'gh pr edit [PR番号] --body \"[生成した説明文]\"'

            重要な注意事項：
            - 必ずgh pr editコマンドでPRの説明文を直接更新してください
            - Git差分を詳細に分析して具体的な説明を提供してください
            - 技術的な詳細も含めて説明してください
            - マークダウン形式で見やすく整理してください"

          # Optional: Advanced settings configuration
          # settings: |
          #   {
          #     "env": {
          #       "NODE_ENV": "development"
          #     }
          #   }
