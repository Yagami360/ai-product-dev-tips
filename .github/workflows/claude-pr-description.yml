name: Claude PR Description Generator

on:
  pull_request:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-pr-description:
    if: |
      (github.event_name == 'pull_request' && github.event.action == 'opened') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude-pr-describe'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # PRå·®åˆ†ã®å–å¾—ã«å¿…è¦

      - name: Setup GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run Claude PR Description Generator
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # PRèª¬æ˜ç”Ÿæˆå°‚ç”¨ã®ãƒˆãƒªã‚¬ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚º
          trigger_phrase: "@claude-pr-describe"

          # PRèª¬æ˜ç”Ÿæˆã«ç‰¹åŒ–ã—ãŸè¨­å®š
          claude_args: |
            --allowedTools "Bash(gh pr edit *),Bash(gh pr view *)"
            --max-turns 5
            --system-prompt "å¸¸ã«æ—¥æœ¬èªã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã¯PRèª¬æ˜æ–‡ç”Ÿæˆå°‚ç”¨ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

            ã€PRä½œæˆã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã€‘
            æ–°ã—ã„Pull RequestãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚GitHubã®UIã‹ã‚‰æ‰‹å‹•ä½œæˆã•ã‚ŒãŸPRã®èª¬æ˜æ–‡ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

            æ‰‹é †ï¼š
            1. 'gh pr view ${{ github.event.pull_request.number }}' ã§PRã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
            2. Gitå·®åˆ†ã‚’è©³ç´°ã«åˆ†æ
            3. ä»¥ä¸‹ã®å½¢å¼ã§èª¬æ˜æ–‡ã‚’ç”Ÿæˆï¼š

            ## ğŸ“‹ å¤‰æ›´å†…å®¹ã®æ¦‚è¦
            - ã“ã®PRã§ä½•ã‚’å®Ÿè£…/ä¿®æ­£ã—ãŸã‹ã‚’ç°¡æ½”ã«èª¬æ˜

            ## ğŸ” å¤‰æ›´è©³ç´°
            - ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã®å¤‰æ›´å†…å®¹
            - è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¿®æ­£ã•ã‚ŒãŸæ©Ÿèƒ½

            ## âœ… ç¢ºèªäº‹é …
            - [ ] å‹•ä½œãƒ†ã‚¹ãƒˆå®Œäº†
            - [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡
            - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã®å¿…è¦æ€§

            ## ğŸš€ å½±éŸ¿ç¯„å›²
            - ã“ã®å¤‰æ›´ãŒä¸ãˆã‚‹å½±éŸ¿
            - æ³¨æ„ã™ã¹ãç‚¹ã‚„ãƒªã‚¹ã‚¯

            ## ğŸ“ å‚™è€ƒ
            - ãã®ä»–è£œè¶³äº‹é …ãŒã‚ã‚Œã°è¨˜è¼‰

            4. 'gh pr edit ${{ github.event.pull_request.number }} --body \"[ç”Ÿæˆã—ãŸèª¬æ˜æ–‡]\"' ã§PRã®èª¬æ˜æ–‡ã‚’ç›´æ¥æ›´æ–°

            ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã€‘
            æ—¢å­˜ã®PRã«å¯¾ã—ã¦ '@claude-pr-describe' ãŒã‚³ãƒ¡ãƒ³ãƒˆã•ã‚Œã¾ã—ãŸã€‚
            1. PRç•ªå·ã‚’ç‰¹å®š
            2. ä¸Šè¨˜ã¨åŒã˜å½¢å¼ã§èª¬æ˜æ–‡ã‚’ç”Ÿæˆ
            3. gh pr editã‚³ãƒãƒ³ãƒ‰ã§PRèª¬æ˜æ–‡ã‚’æ›´æ–°ã€ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã§èª¬æ˜ã‚’æä¾›

            é‡è¦ï¼š
            - PRèª¬æ˜æ–‡ãŒç©ºã®å ´åˆã¯å¿…ãšgh pr editã§æ›´æ–°ã—ã¦ãã ã•ã„
            - PRèª¬æ˜æ–‡ãŒæ—¢ã«ã‚ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã§è£œè¶³èª¬æ˜ã‚’æä¾›ã—ã¦ãã ã•ã„
            - Gitå·®åˆ†ã‚’è©³ç´°ã«åˆ†æã—ã¦ãã ã•ã„
            - å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã«åŸºã¥ã„ãŸå…·ä½“çš„ãªèª¬æ˜ã‚’æä¾›ã—ã¦ãã ã•ã„
            - æŠ€è¡“çš„ãªè©³ç´°ã‚‚å«ã‚ã¦èª¬æ˜ã—ã¦ãã ã•ã„"

          # Optional: Advanced settings configuration
          # settings: |
          #   {
          #     "env": {
          #       "NODE_ENV": "development"
          #     }
          #   }
