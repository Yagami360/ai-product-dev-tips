name: Claude PR Description Generator

on:
  pull_request:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  auto-comment:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Add automatic PR description trigger
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d '{"body":"@claude-pr-describe"}'

  claude-pr-description:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude-pr-describe')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # PRå·®åˆ†ã®å–å¾—ã«å¿…è¦

      - name: Setup GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Run Claude PR Description Generator
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # PRèª¬æ˜ç”Ÿæˆå°‚ç”¨ã®ãƒˆãƒªã‚¬ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚º
          trigger_phrase: "@claude-pr-describe"

          # PRèª¬æ˜ç”Ÿæˆã«ç‰¹åŒ–ã—ãŸè¨­å®š
          claude_args: |
            --allowedTools "Bash(gh pr edit *),Bash(gh pr view *)"
            --max-turns 5
            --system-prompt "å¸¸ã«æ—¥æœ¬èªã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã¯PRèª¬æ˜æ–‡ç”Ÿæˆå°‚ç”¨ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

            ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ–°ã—ã„Pull Requestã®ä½œæˆæ™‚ã¾ãŸã¯PRã§ã® '@claude-pr-describe' ã‚³ãƒ¡ãƒ³ãƒˆæ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

            å®Ÿè¡Œæ‰‹é †ï¼š
            1. ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒèµ·å‹•ã—ãŸç†ç”±ï¼ˆPRä½œæˆ or ã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã«é–¢ä¿‚ãªãã€å¿…ãšPRèª¬æ˜æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
            2. Gitå·®åˆ†ã‚’è©³ç´°ã«åˆ†æ
            3. ä»¥ä¸‹ã®å½¢å¼ã§æ§‹é€ åŒ–ã•ã‚ŒãŸèª¬æ˜æ–‡ã‚’ç”Ÿæˆï¼š

            ## ğŸ“‹ å¤‰æ›´å†…å®¹ã®æ¦‚è¦
            - ã“ã®PRã§ä½•ã‚’å®Ÿè£…/ä¿®æ­£ã—ãŸã‹ã‚’ç°¡æ½”ã«èª¬æ˜

            ## ğŸ” å¤‰æ›´è©³ç´°
            - ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã®å¤‰æ›´å†…å®¹
            - è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¿®æ­£ã•ã‚ŒãŸæ©Ÿèƒ½

            ## âœ… ç¢ºèªäº‹é …
            - [ ] å‹•ä½œãƒ†ã‚¹ãƒˆå®Œäº†
            - [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡
            - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã®å¿…è¦æ€§

            ## ğŸš€ å½±éŸ¿ç¯„å›²
            - ã“ã®å¤‰æ›´ãŒä¸ãˆã‚‹å½±éŸ¿
            - æ³¨æ„ã™ã¹ãç‚¹ã‚„ãƒªã‚¹ã‚¯

            ## ğŸ“ å‚™è€ƒ
            - ãã®ä»–è£œè¶³äº‹é …ãŒã‚ã‚Œã°è¨˜è¼‰

            4. ç”Ÿæˆã—ãŸèª¬æ˜æ–‡ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š
               - PRç•ªå·ã‚’ç¢ºèª: 'gh pr view --json number'
               - PRèª¬æ˜æ–‡ã‚’æ›´æ–°: 'gh pr edit [PRç•ªå·] --body \"[ç”Ÿæˆã—ãŸèª¬æ˜æ–‡]\"'

            é‡è¦ãªæ³¨æ„äº‹é …ï¼š
            - å¿…ãšgh pr editã‚³ãƒãƒ³ãƒ‰ã§PRã®èª¬æ˜æ–‡ã‚’ç›´æ¥æ›´æ–°ã—ã¦ãã ã•ã„
            - Gitå·®åˆ†ã‚’è©³ç´°ã«åˆ†æã—ã¦å…·ä½“çš„ãªèª¬æ˜ã‚’æä¾›ã—ã¦ãã ã•ã„
            - æŠ€è¡“çš„ãªè©³ç´°ã‚‚å«ã‚ã¦èª¬æ˜ã—ã¦ãã ã•ã„
            - ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§è¦‹ã‚„ã™ãæ•´ç†ã—ã¦ãã ã•ã„"

          # Optional: Advanced settings configuration
          # settings: |
          #   {
          #     "env": {
          #       "NODE_ENV": "development"
          #     }
          #   }
